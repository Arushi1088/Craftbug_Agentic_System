<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UX Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-card .label {
            color: #666;
            font-size: 1.1em;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4em;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .alerts-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .alerts-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4em;
        }

        .alert-item {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .alert-item.high {
            border-left-color: #e74c3c;
        }

        .alert-item.medium {
            border-left-color: #f39c12;
        }

        .alert-item.low {
            border-left-color: #2ecc71;
        }

        .alert-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-message {
            color: #666;
            margin-bottom: 8px;
        }

        .alert-meta {
            font-size: 0.9em;
            color: #999;
        }

        .recommendations-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .recommendations-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4em;
        }

        .recommendation-item {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        .last-updated {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-style: italic;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 10px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>üéØ UX Analytics Dashboard</h1>
            <p class="subtitle">Real-time monitoring and insights for Office application UX testing</p>
            <button class="refresh-btn" onclick="loadDashboardData()">üîÑ Refresh Data</button>
            <button class="refresh-btn" onclick="testEndToEndWorkflow()">üß™ Test E2E Workflow</button>
            <button class="refresh-btn" onclick="loadAvailableReports()">üìã Load Reports</button>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            üìä Loading dashboard data...
        </div>

        <!-- Main Dashboard Content -->
        <div id="dashboard-content" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üß™</div>
                    <div class="value" id="total-scenarios">-</div>
                    <div class="label">Total Scenarios</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üêõ</div>
                    <div class="value" id="total-issues">-</div>
                    <div class="label">Issues Found</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="value" id="active-alerts">-</div>
                    <div class="label">Active Alerts</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üìà</div>
                    <div class="value" id="avg-issues">-</div>
                    <div class="label">Avg Issues/Scenario</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üì± Issues by Application</h3>
                    <div class="chart-container">
                        <canvas id="appChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üéØ Issues by Severity</h3>
                    <div class="chart-container">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üìä Daily Trend</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üè∑Ô∏è Top Issue Categories</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Alerts Section -->
            <div class="alerts-section">
                <h3>üö® Active Alerts</h3>
                <div id="alerts-container">
                    <!-- Alerts will be populated here -->
                </div>
            </div>

            <!-- Recommendations Section -->
            <div class="recommendations-section">
                <h3>üí° Recommendations</h3>
                <div id="recommendations-container">
                    <!-- Recommendations will be populated here -->
                </div>
            </div>

            <div class="last-updated" id="last-updated">
                <!-- Last updated time will be shown here -->
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        async function loadDashboardData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';

            try {
                // In a real implementation, this would fetch from an API
                // For demo purposes, we'll use mock data
                const data = await getMockDashboardData();
                updateDashboard(data);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        async function getMockDashboardData() {
            // Try to fetch real data from API first
            try {
                const response = await fetch('/api/dashboard/analytics?days=7');
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Loaded real dashboard data from API');
                    return data;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è API not available, using mock data');
            }

            // Fallback to mock data if API is not available
            await new Promise(resolve => setTimeout(resolve, 1000));

            return {
                "generated_at": new Date().toISOString(),
                "period_days": 7,
                "summary": {
                    "total_runs": 15,
                    "total_scenarios": 42,
                    "total_issues": 23,
                    "issues_by_app": {
                        "word": 8,
                        "excel": 10,
                        "powerpoint": 5
                    },
                    "issues_by_severity": {
                        "high": 3,
                        "medium": 12,
                        "low": 8
                    },
                    "issues_by_category": {
                        "Navigation": 7,
                        "Performance": 5,
                        "Accessibility": 4,
                        "Visual Design": 3,
                        "User Flow": 4
                    },
                    "daily_trend": {
                        "2024-01-24": 2,
                        "2024-01-25": 4,
                        "2024-01-26": 3,
                        "2024-01-27": 6,
                        "2024-01-28": 4,
                        "2024-01-29": 2,
                        "2024-01-30": 2
                    }
                },
                "metrics": {
                    "average_issues_per_scenario": 0.55,
                    "most_problematic_app": "excel",
                    "trend_direction": "stable"
                },
                "alerts": [
                    {
                        "alert_id": "high_issues_20240130_140000",
                        "title": "High Issue Count in Excel",
                        "message": "Found 10 issues in 8 scenarios (avg: 1.3)",
                        "severity": "medium",
                        "timestamp": "2024-01-30T14:00:00",
                        "app_type": "excel",
                        "resolved": false
                    },
                    {
                        "alert_id": "critical_issues_20240130_120000",
                        "title": "Critical Issues Detected in Word",
                        "message": "Found 3 critical severity issues requiring immediate attention",
                        "severity": "high",
                        "timestamp": "2024-01-30T12:00:00",
                        "app_type": "word",
                        "resolved": false
                    }
                ],
                "recommendations": [
                    "Focus UX attention on Excel application - highest issue count (10 issues)",
                    "Address high-severity issues immediately - user experience significantly impacted",
                    "Consider prioritizing Navigation category improvements - most common issue type"
                ]
            };
        }

        function updateDashboard(data) {
            // Update stats
            document.getElementById('total-scenarios').textContent = data.summary.total_scenarios;
            document.getElementById('total-issues').textContent = data.summary.total_issues;
            document.getElementById('active-alerts').textContent = data.alerts.length;
            document.getElementById('avg-issues').textContent = data.metrics.average_issues_per_scenario.toFixed(1);

            // Update charts
            updateAppChart(data.summary.issues_by_app);
            updateSeverityChart(data.summary.issues_by_severity);
            updateTrendChart(data.summary.daily_trend);
            updateCategoryChart(data.summary.issues_by_category);

            // Update alerts
            updateAlerts(data.alerts);

            // Update recommendations
            updateRecommendations(data.recommendations);

            // Update last updated time
            document.getElementById('last-updated').textContent = 
                `Last updated: ${new Date(data.generated_at).toLocaleString()}`;

            // Show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
        }

        function updateAppChart(data) {
            const ctx = document.getElementById('appChart').getContext('2d');
            
            if (charts.appChart) {
                charts.appChart.destroy();
            }

            charts.appChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data).map(app => app.charAt(0).toUpperCase() + app.slice(1)),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateSeverityChart(data) {
            const ctx = document.getElementById('severityChart').getContext('2d');
            
            if (charts.severityChart) {
                charts.severityChart.destroy();
            }

            charts.severityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#E74C3C', '#F39C12', '#2ECC71'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (charts.trendChart) {
                charts.trendChart.destroy();
            }

            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Issues',
                        data: Object.values(data),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (charts.categoryChart) {
                charts.categoryChart.destroy();
            }

            charts.categoryChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="no-data">üéâ No active alerts - all systems running smoothly!</div>';
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.severity}">
                    <div class="alert-title">${alert.title}</div>
                    <div class="alert-message">${alert.message}</div>
                    <div class="alert-meta">
                        ${alert.app_type.toUpperCase()} ‚Ä¢ ${new Date(alert.timestamp).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations-container');
            
            if (recommendations.length === 0) {
                container.innerHTML = '<div class="no-data">No specific recommendations at this time.</div>';
                return;
            }

            container.innerHTML = recommendations.map((rec, index) => `
                <div class="recommendation-item">
                    ${index + 1}. ${rec}
                </div>
            `).join('');
        }

        function showError(message) {
            document.getElementById('loading').innerHTML = `‚ùå ${message}`;
        }

        async function testEndToEndWorkflow() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').innerHTML = 'üß™ Testing end-to-end workflow...';
                
                // First get available reports
                const reportsResponse = await fetch('/api/reports');
                const reports = await reportsResponse.json();
                
                if (reports.length === 0) {
                    alert('No analysis reports found. Please run some UX analysis first.');
                    return;
                }
                
                // Use the latest report
                const latestReport = reports[0];
                
                // Step 1: Process results for dashboard
                document.getElementById('loading').innerHTML = 'üìä Processing results for dashboard...';
                const processResponse = await fetch('/api/dashboard/process-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `report_id=${latestReport.id}`
                });
                
                if (!processResponse.ok) {
                    throw new Error('Failed to process results');
                }
                
                // Step 2: Create ADO tickets
                document.getElementById('loading').innerHTML = 'üé´ Creating Azure DevOps tickets...';
                const adoResponse = await fetch('/api/dashboard/create-ado-tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `report_id=${latestReport.id}&demo_mode=true`
                });
                
                const adoResult = await adoResponse.json();
                
                // Step 3: Refresh dashboard
                document.getElementById('loading').innerHTML = 'üîÑ Refreshing dashboard...';
                await loadDashboardData();
                
                alert(`‚úÖ End-to-end workflow completed!\n\nüìä Dashboard updated\nüé´ ${adoResult.work_items_created} ADO tickets created\nüß™ Test Report: ${latestReport.id}`);
                
            } catch (error) {
                console.error('E2E workflow error:', error);
                alert(`‚ùå End-to-end test failed: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadAvailableReports() {
            try {
                const response = await fetch('/api/reports');
                const reports = await response.json();
                
                const reportsHtml = reports.map(report => `
                    <div class="alert-item">
                        <div class="alert-title">üìÑ ${report.id}</div>
                        <div class="alert-message">
                            App: ${report.app_type || 'Unknown'} | 
                            Issues: ${report.total_issues || 0} | 
                            Created: ${new Date(report.timestamp).toLocaleString()}
                        </div>
                        <button onclick="processReport('${report.id}')" style="margin-top: 8px; padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üîÑ Process for Dashboard
                        </button>
                        <button onclick="createADOTickets('${report.id}')" style="margin: 8px 0 0 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üé´ Create ADO Tickets
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('alerts-container').innerHTML = 
                    `<h4>üìã Available Analysis Reports (${reports.length})</h4>` + reportsHtml;
                
            } catch (error) {
                console.error('Failed to load reports:', error);
                alert('Failed to load reports');
            }
        }

        async function processReport(reportId) {
            try {
                const response = await fetch('/api/dashboard/process-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `report_id=${reportId}`
                });
                
                if (response.ok) {
                    alert('‚úÖ Report processed for dashboard');
                    await loadDashboardData();
                } else {
                    throw new Error('Processing failed');
                }
            } catch (error) {
                alert(`‚ùå Failed to process report: ${error.message}`);
            }
        }

        async function createADOTickets(reportId) {
            try {
                const response = await fetch('/api/dashboard/create-ado-tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `report_id=${reportId}&demo_mode=true`
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Created ${result.work_items_created} ADO tickets\n(Demo mode: ${result.demo_mode})`);
                } else {
                    throw new Error(result.detail || 'Ticket creation failed');
                }
            } catch (error) {
                alert(`‚ùå Failed to create ADO tickets: ${error.message}`);
            }
        }

        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', loadDashboardData);

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
